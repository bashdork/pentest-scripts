#!/bin/bash

IFS=$'\n'  #Make newlines the only separator.


function f_createPortList {

cat services |cut -d$'\t' -f 2 |sort -n -u > ports # -n sorts numerically

}

function f_services4report {

f_createPortList

for port in $(cat ports); do

	IPS=$(cat services |awk {'print $1,$2'} |grep " $port" |sort -u |cut -d " " -f1)
	SERV=$(cat services |awk {'print $1,$2,$4'} |grep $port |sort -u |grep " $port " |cut -d " " -f 3 |sort -u)
	echo -e "\"$IPS\",$port,TCP,$SERV" >> report_table.csv

done

rm ports

}

function f_services {

echo "*********************************************"
echo "             SERVICES             "
echo "*********************************************"
cat services |sort -n -k2

[ -f nmap_results/results_nmap.gnmap ] && f_services4report || echo "No nmap gnmap file."

}

function f_nmap {
mkdir nmap_results

nmap -vvv -T4 -sS -iL hosts -oA nmap_results/results_nmap


for ip in $(grep open nmap_results/results_nmap.gnmap |cut -d " " -f 2); do

	for port in $(grep 'open' nmap_results/results_nmap.nmap |cut -d " " -f 1 |tr -d "/tcp"); do

		banner=$(cat nmap_results/results_nmap.nmap |grep 'open'|grep $port$'/tcp' |awk {'print $3'} |sort -u)
		echo $ip$'\t'$port$'\t'TCP$'\t'$banner >> services
	done

done

f_services

}

function f_expand {

echo "************************"
echo "    Hosts             "
echo "************************"

nmap -sL -n -iL scope |grep report |cut -d " " -f 5,6 |tr -d "()" |cut -d " " -f2 |sort -u |tee -a hosts

echo "************************"


f_nmap

}

function f_checkForScope {

[ -f scope ] && f_expand || echo "There is no hosts or scope file in this folder."

}

[ -f hosts ] && f_nmap || f_checkForScope # START
